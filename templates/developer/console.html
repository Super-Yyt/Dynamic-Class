{% extends "dev.html" %}

{% block title %}开发者控制台 - Dlass{% endblock %}

{% block content %}
<div class="developer-container">
    <!-- 页面头部 -->
    <div class="developer-header">
        <div class="header-content">
            <h1 class="developer-title">开发者控制台</h1>
            <p class="developer-subtitle">管理您的应用和API凭证</p>
        </div>
        <div class="header-actions">
            <a href="{{ url_for('developer.create_app') }}" class="btn-developer">
                <i class="material-icons">add</i>
                <span>创建新应用</span>
            </a>
        </div>
    </div>

    <!-- 开发者信息 -->
    <div class="developer-info-card">
        <h3 class="card-title">开发者信息</h3>
        <div class="developer-info-grid">
            <div class="info-item">
                <span class="info-label">公司/组织</span>
                <span class="info-value">{{ developer.company }}</span>
            </div>
            <div class="info-item">
                <span class="info-label">用户名</span>
                <span class="info-value">{{ developer.user.username }}</span>
            </div>
            <div class="info-item">
                <span class="info-label">注册时间</span>
                <span class="info-value">{{ developer.created_at.strftime('%Y-%m-%d %H:%M') }}</span>
            </div>
        </div>
        {% if developer.description %}
        <div class="info-description">
            <strong>描述:</strong> {{ developer.description }}
        </div>
        {% endif %}
    </div>

    <!-- 应用列表 -->
    <div class="section-header">
        <h3 class="section-title">我的应用</h3>
        <span class="app-count">{{ apps|length }} 个应用</span>
    </div>

    {% if apps %}
    <div class="apps-grid">
        {% for app in apps %}
        <div class="app-card">
            <div class="app-card-header">
                <h4 class="app-name">{{ app.app_name }}</h4>
                <span class="app-status {% if app.status == 'approved' %}status-approved{% elif app.status == 'pending' %}status-pending{% else %}status-rejected{% endif %}">
                    {% if app.status == 'approved' %}已批准
                    {% elif app.status == 'pending' %}待审核
                    {% else %}已拒绝{% endif %}
                </span>
            </div>
            <div class="app-id">App ID: {{ app.app_id }}</div>
            {% if app.description %}
            <div class="app-description">{{ app.description }}</div>
            {% endif %}
            <div class="app-meta">
                <span class="app-created">创建于 {{ app.created_at.strftime('%Y-%m-%d') }}</span>
            </div>
            <div class="app-actions">
                <button type="button" class="btn-developer btn-developer-warning outline-btn small-btn" 
                        onclick="resetAppSecret('{{ app.app_id }}')">
                    <i class="material-icons">refresh</i>
                    <span>重置密钥</span>
                </button>
                <button type="button" class="btn-developer-outline outline-btn small-btn" 
                        onclick="deleteApp('{{ app.app_id }}')">
                    <i class="material-icons">delete</i>
                    <span>删除</span>
                </button>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="developer-empty-state">
        <i class="material-icons empty-icon">apps</i>
        <h3 class="empty-title">还没有应用</h3>
        <p class="empty-description">创建您的第一个应用来开始集成Dlass系统</p>
        <a href="{{ url_for('developer.create_app') }}" class="btn-developer">
            <i class="material-icons">add</i>
            <span>创建第一个应用</span>
        </a>
    </div>
    {% endif %}

    <!-- API文档链接 -->
    <div class="api-docs">
        <h3 class="api-docs-header">需要帮助？</h3>
        <p>查看我们的API文档了解如何集成您的应用</p>
        <a href="#" class="btn-developer-outline">
            <i class="material-icons">description</i>
            <span>查看API文档</span>
        </a>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function resetAppSecret(appId) {
    if (confirm('确定要重置应用密钥吗？旧密钥将立即失效，请确保更新所有使用旧密钥的地方！')) {
        // 显示加载状态
        const button = event.target.closest('button');
        const originalText = button.innerHTML;
        button.innerHTML = '<i class="material-icons">refresh</i><span>重置中...</span>';
        button.disabled = true;

        fetch(`/developer/apps/${appId}/reset-secret`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showMessage('密钥重置成功！新密钥：' + data.new_secret + '\n\n请妥善保存，此密钥只会显示一次！', 'success');
            } else {
                showMessage('重置失败：' + data.error, 'error');
            }
        })
        .catch(error => {
            showMessage('请求失败：' + error, 'error');
        })
        .finally(() => {
            button.innerHTML = originalText;
            button.disabled = false;
        });
    }
}

function deleteApp(appId) {
    if (confirm('确定要删除这个应用吗？此操作不可恢复，所有使用此应用的服务将立即停止工作！')) {
        // 显示加载状态
        const button = event.target.closest('button');
        const originalText = button.innerHTML;
        button.innerHTML = '<i class="material-icons">delete</i><span>删除中...</span>';
        button.disabled = true;

        fetch(`/developer/apps/${appId}/delete`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showMessage('应用删除成功', 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showMessage('删除失败：' + data.error, 'error');
            }
        })
        .catch(error => {
            showMessage('请求失败：' + error, 'error');
        })
        .finally(() => {
            button.innerHTML = originalText;
            button.disabled = false;
        });
    }
}
</script>
{% endblock %}