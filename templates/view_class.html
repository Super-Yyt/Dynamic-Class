{% extends "base.html" %}

{% block title %}{{ class_obj.name }} - Dlass{% endblock %}

{% block content %}
<div class="view-class-container">
    <div class="class-header">
        <div class="class-title-section">
            <h1 class="class-title">{{ class_obj.name }}</h1>
            {% if is_owner %}
            <button class="icon-btn" onclick="copyClassCode()" title="复制班级代码">
                <i class="material-icons">content_copy</i>
            </button>
            {% endif %}
        </div>
        
        <div class="class-actions">
            <button class="action-btn" onclick="refreshWhiteboardStatus()" title="刷新状态">
                <i class="material-icons">refresh</i>
                <span>刷新</span>
            </button>
            {% if is_owner %}
            <a href="{{ url_for('settings.class_settings', class_id=class_obj.id) }}" class="outline-btn">
                <i class="material-icons">settings</i>
                <span>班级设置</span>
            </a>
            {% endif %}
        </div>
    </div>
    
    <div class="class-info-card">
        <div class="card-content">
            <p class="class-description">{{ class_obj.description or '暂无描述' }}</p>
            
            <div class="class-meta-tags">
                {% if is_owner %}
                <div class="meta-tag">
                    <span class="tag-label">班级代码:</span>
                    <span class="tag-value">{{ class_obj.code }}</span>
                </div>
                {% endif %}
                <div class="meta-tag">
                    <span class="tag-label">创建时间:</span>
                    <span class="tag-value">{{ class_obj.created_at.strftime('%Y-%m-%d') }}</span>
                </div>
                {% if not is_owner %}
                <div class="meta-tag">
                    <span class="tag-label">您的角色:</span>
                    <span class="tag-value">授课老师</span>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <h2 class="section-title">班级功能</h2>
    <div class="features-grid">
        <div class="feature-card">
            <div class="feature-icon">
                <i class="material-icons">group</i>
            </div>
            <h3 class="feature-title">学生管理</h3>
            <p class="feature-description">管理班级中的学生</p>
        </div>
        
        <div class="feature-card" onclick="location.href='{{ url_for('web_notes.class_notes_page', class_id=class_obj.id) }}'" style="cursor: pointer;">
            <div class="feature-icon">
                <i class="material-icons">note</i>
            </div>
            <h3 class="feature-title">笔记管理</h3>
            <p class="feature-description">查看和管理班级笔记</p>
        </div>
    </div>
    
    <h2 class="section-title">白板设备</h2>
    <div class="whiteboards-grid" id="whiteboards-container">
        {% if class_obj.whiteboards %}
            {% for whiteboard in class_obj.whiteboards %}
            <div class="whiteboard-card" id="whiteboard-{{ whiteboard.id }}">
                <div class="card-content">
                    <div class="whiteboard-icon">
                        <i class="material-icons">desktop_windows</i>
                    </div>
                    <h3 class="whiteboard-name">{{ whiteboard.name }}</h3>
                    <p class="whiteboard-id">ID: {{ whiteboard.board_id }}</p>
                    <div class="whiteboard-status">
                        <span class="status-label">状态:</span>
                        <span class="status-indicator" data-whiteboard-id="{{ whiteboard.id }}">
                            {% if whiteboard.is_online %}
                            <span class="status-online">在线</span>
                            {% else %}
                            <span class="status-offline">离线</span>
                            {% endif %}
                        </span>
                        <span class="last-heartbeat">
                            {% if whiteboard.last_heartbeat %}
                            (最后心跳: {{ whiteboard.last_heartbeat.strftime('%Y-%m-%d %H:%M') }})
                            {% endif %}
                        </span>
                    </div>
                    <a href="{{ url_for('whiteboards.view_whiteboard', whiteboard_id=whiteboard.id) }}" class="outline-btn small-btn">
                        <span class="btn-label">管理白板</span>
                    </a>
                </div>
            </div>
            {% endfor %}
        {% else %}
        <div class="empty-state">
            <div class="empty-content">
                <i class="material-icons empty-icon">desktop_windows</i>
                <h3 class="empty-title">暂无白板设备</h3>
                <p class="empty-description">为班级添加白板设备开始管理</p>
            </div>
        </div>
        {% endif %}
        
        <div class="add-whiteboard-card">
            <div class="card-content">
                <div class="add-icon">
                    <i class="material-icons">add_circle</i>
                </div>
                <h3 class="add-title">添加白板设备</h3>
                <p class="add-description">创建新的白板设备</p>
                <a href="{{ url_for('whiteboards.create_whiteboard', class_id=class_obj.id) }}" class="outline-btn small-btn">
                    <span class="btn-label">创建白板</span>
                </a>
            </div>
        </div>
    </div>
</div>

<script>
// 初始化Socket.IO连接
const socket = io({
    transports: ['websocket', 'polling']
});

// 连接建立时
socket.on('connect', () => {
    console.log('已连接到服务器');
    // 加入教师房间
    socket.emit('join_teacher_room');
});

// 连接断开时
socket.on('disconnect', () => {
    console.log('与服务器断开连接');
    // 将所有白板状态标记为离线
    document.querySelectorAll('.status-indicator').forEach(el => {
        el.innerHTML = '<span class="status-offline">离线</span>';
    });
});

// 接收白板状态更新
socket.on('whiteboard_status_update', (data) => {
    updateWhiteboardStatus(data.whiteboard_id, data.is_online, data.last_heartbeat);
});

// 更新白板状态显示
function updateWhiteboardStatus(whiteboardId, isOnline, lastHeartbeat) {
    const statusElement = document.querySelector(`.status-indicator[data-whiteboard-id="${whiteboardId}"]`);
    const whiteboardCard = document.getElementById(`whiteboard-${whiteboardId}`);
    
    if (statusElement) {
        if (isOnline) {
            statusElement.innerHTML = '<span class="status-online">在线</span>';
        } else {
            statusElement.innerHTML = '<span class="status-offline">离线</span>';
        }
    }
    
    // 更新最后心跳时间
    if (lastHeartbeat && whiteboardCard) {
        const heartbeatElement = whiteboardCard.querySelector('.last-heartbeat');
        if (heartbeatElement) {
            heartbeatElement.textContent = `(最后心跳: ${lastHeartbeat})`;
        }
    }
}

// 复制班级代码
function copyClassCode() {
    {% if is_owner %}
    navigator.clipboard.writeText("{{ class_obj.code }}")
        .then(() => {
            showMessage('班级代码已复制到剪贴板', 'success');
        })
        .catch(err => {
            console.error('复制失败:', err);
            showMessage('复制失败', 'error');
        });
    {% endif %}
}

// 刷新白板状态
function refreshWhiteboardStatus() {
    showMessage('状态已刷新', 'success');
}

// 显示消息提示
function showMessage(message, type = 'success') {
    const messageEl = document.createElement('div');
    messageEl.className = `message ${type}`;
    messageEl.innerHTML = `
        <div class="message-content">
            <i class="material-icons message-icon">${type === 'error' ? 'error' : 'check_circle'}</i>
            <span class="message-text">${message}</span>
        </div>
    `;
    document.body.appendChild(messageEl);
    
    setTimeout(() => {
        if (document.body.contains(messageEl)) {
            document.body.removeChild(messageEl);
        }
    }, 3000);
}
</script>
{% endblock %}