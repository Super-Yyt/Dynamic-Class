{% extends "base.html" %}

{% block title %}笔记管理 - {{ class_obj.name }} - Dlass{% endblock %}

{% block extra_css %}
<style>
.notes-management-container {
    padding: 20px;
    max-width: 1400px;
    margin: 0 auto;
}

/* 页面标题区域 */
.notes-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
    padding: 0 8px;
}

.notes-title {
    font-size: 2rem;
    font-weight: 700;
    color: #2c3e50;
    margin: 0;
}

.notes-subtitle {
    color: #7f8c8d;
    margin-top: 4px;
}

.notes-actions {
    display: flex;
    gap: 12px;
}

/* 统计卡片 */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    margin-bottom: 24px;
}

.stat-card {
    background: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    text-align: center;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.stat-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 16px rgba(0,0,0,0.12);
}

.stat-value {
    font-size: 2rem;
    font-weight: 700;
    color: #3498db;
    margin-bottom: 4px;
}

.stat-label {
    color: #7f8c8d;
    font-size: 14px;
}

/* 筛选和搜索区域 */
.filters-section {
    background: white;
    border-radius: 12px;
    padding: 24px;
    margin-bottom: 24px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}

.filters-row {
    display: grid;
    grid-template-columns: 2fr 1fr 1fr 1fr auto;
    gap: 16px;
    align-items: end;
}

.filter-group {
    display: flex;
    flex-direction: column;
    position: relative;
}

.filter-label {
    font-weight: 500;
    color: #2c3e50;
    margin-bottom: 8px;
    font-size: 14px;
}

.search-input {
    width: 100%;
    padding: 12px;
    border: 2px solid #ecf0f1;
    border-radius: 8px;
    font-size: 14px;
    transition: all 0.3s ease;
    background: white;
}

.search-input:focus {
    outline: none;
    border-color: #3498db;
    box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
}

/* 美化下拉框样式 */
.filter-select {
    width: 100%;
    padding: 12px 40px 12px 12px;
    border: 2px solid #ecf0f1;
    border-radius: 8px;
    font-size: 14px;
    background: white url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%237f8c8d' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E") no-repeat right 12px center;
    background-size: 16px;
    cursor: pointer;
    appearance: none;
    transition: all 0.3s ease;
    position: relative;
    z-index: 1;
}

.filter-select:focus {
    outline: none;
    border-color: #3498db;
    box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
}

.filter-select:hover {
    border-color: #bdc3c7;
}

/* 下拉框动画效果 */
.filter-select-wrapper {
    position: relative;
}

.filter-select-wrapper::after {
    content: '';
    position: absolute;
    top: 50%;
    right: 12px;
    transform: translateY(-50%);
    width: 16px;
    height: 16px;
    pointer-events: none;
    z-index: 2;
}

/* 笔记表格 */
.notes-table-container {
    background: white;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    position: relative;
}

.notes-table {
    width: 100%;
    border-collapse: collapse;
}

.notes-table th {
    background: #f8f9fa;
    padding: 16px;
    text-align: left;
    font-weight: 600;
    color: #2c3e50;
    border-bottom: 2px solid #ecf0f1;
    font-size: 14px;
}

.notes-table td {
    padding: 16px;
    border-bottom: 1px solid #ecf0f1;
    font-size: 14px;
}

.notes-table tr {
    transition: background-color 0.2s ease;
}

.notes-table tr:hover {
    background: #f8f9fa;
}

/* 文件信息列 */
.file-info {
    display: flex;
    align-items: center;
    gap: 12px;
}

.file-icon {
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #e3f2fd;
    border-radius: 8px;
    color: #3498db;
    font-size: 18px;
    transition: transform 0.2s ease;
}

.file-icon:hover {
    transform: scale(1.1);
}

.file-details {
    display: flex;
    flex-direction: column;
}

.file-name {
    font-weight: 500;
    color: #2c3e50;
    margin-bottom: 2px;
}

.file-meta {
    color: #7f8c8d;
    font-size: 12px;
}

/* 标签样式 */
.tags-container {
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
}

.tag {
    background: #e3f2fd;
    color: #1976d2;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 500;
}

/* 状态标签 */
.status-badge {
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 500;
}

.status-active {
    background: #d4edda;
    color: #155724;
}

.status-archived {
    background: #e2e3e5;
    color: #383d41;
}

/* 操作按钮 */
.actions-cell {
    display: flex;
    gap: 8px;
}

.action-icon {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 32px;
    height: 32px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.3s ease;
    color: #7f8c8d;
    background: none;
}

.action-icon:hover {
    background: #f8f9fa;
    transform: translateY(-2px);
}

.action-preview:hover {
    color: #3498db;
}

.action-download:hover {
    color: #27ae60;
}

.action-delete:hover {
    color: #e74c3c;
    background: #fadbd8;
}

/* 空状态 */
.empty-state {
    text-align: center;
    padding: 60px 20px;
    color: #95a5a6;
}

.empty-icon {
    font-size: 64px;
    margin-bottom: 16px;
    color: #bdc3c7;
}

.empty-title {
    font-size: 1.25rem;
    font-weight: 600;
    margin-bottom: 8px;
    color: #7f8c8d;
}

.empty-description {
    margin-bottom: 24px;
}

/* 分页 */
.pagination {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 16px;
    padding: 20px;
    border-top: 1px solid #ecf0f1;
}

.pagination-info {
    color: #7f8c8d;
    font-size: 14px;
}

.pagination-controls {
    display: flex;
    gap: 8px;
}

.pagination-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 40px;
    height: 40px;
    border: 1px solid #ecf0f1;
    background: white;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
    color: #7f8c8d;
}

.pagination-btn:hover:not(:disabled) {
    border-color: #3498db;
    color: #3498db;
    transform: translateY(-2px);
}

.pagination-btn:disabled {
    background: #f8f9fa;
    color: #bdc3c7;
    cursor: not-allowed;
}

.pagination-btn.active {
    background: #3498db;
    border-color: #3498db;
    color: white;
}

/* 加载状态 */
.loading-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255, 255, 255, 0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10;
}

.loading-spinner {
    width: 40px;
    height: 40px;
    border: 3px solid #f3f3f3;
    border-top: 3px solid #3498db;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* 按钮样式 */
.primary-btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 12px 24px;
    background: #3498db;
    color: white;
    border: none;
    border-radius: 8px;
    text-decoration: none;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
}

.primary-btn:hover {
    background: #2980b9;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}

.outline-btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 12px 24px;
    background: white;
    color: #3498db;
    border: 2px solid #3498db;
    border-radius: 8px;
    text-decoration: none;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
}

.outline-btn:hover {
    background: #3498db;
    color: white;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}

.action-btn {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 16px;
    background: #3498db;
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.3s ease;
}

.action-btn:hover {
    background: #2980b9;
    transform: translateY(-2px);
}

/* 预览模态框样式 */
.preview-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.8);
    z-index: 2000;
    align-items: center;
    justify-content: center;
    animation: fadeIn 0.3s ease;
}

.preview-content {
    background: white;
    border-radius: 12px;
    max-width: 90%;
    max-height: 90%;
    width: auto;
    height: auto;
    overflow: auto;
    position: relative;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    animation: scaleIn 0.3s ease;
}

.preview-close {
    position: absolute;
    top: 12px;
    right: 12px;
    background: rgba(0,0,0,0.5);
    color: white;
    border: none;
    border-radius: 50%;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 2001;
    transition: all 0.3s ease;
}

.preview-close:hover {
    background: rgba(0,0,0,0.7);
    transform: rotate(90deg);
}

.preview-body {
    padding: 20px;
    text-align: center;
}

/* 预览动画 */
@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes scaleIn {
    from { transform: scale(0.9); opacity: 0; }
    to { transform: scale(1); opacity: 1; }
}

/* 响应式设计 */
@media (max-width: 1024px) {
    .filters-row {
        grid-template-columns: 1fr 1fr;
        gap: 12px;
    }
    
    .notes-table {
        font-size: 13px;
    }
    
    .notes-table th,
    .notes-table td {
        padding: 12px 8px;
    }
}

@media (max-width: 768px) {
    .notes-management-container {
        padding: 12px;
    }
    
    .notes-header {
        flex-direction: column;
        gap: 16px;
        align-items: flex-start;
    }
    
    .notes-actions {
        width: 100%;
        justify-content: flex-start;
    }
    
    .filters-row {
        grid-template-columns: 1fr;
    }
    
    .stats-grid {
        grid-template-columns: repeat(2, 1fr);
    }
    
    /* 表格响应式 */
    .notes-table-container {
        overflow-x: auto;
    }
    
    .notes-table {
        min-width: 800px;
    }
    
    .file-info {
        min-width: 200px;
    }
}

@media (max-width: 480px) {
    .stats-grid {
        grid-template-columns: 1fr;
    }
    
    .notes-table th:nth-child(4),
    .notes-table td:nth-child(4),
    .notes-table th:nth-child(5),
    .notes-table td:nth-child(5) {
        display: none;
    }
    
    .preview-content {
        max-width: 95%;
        max-height: 95%;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="notes-management-container">
    <!-- 页面标题 -->
    <div class="notes-header">
        <div>
            <h1 class="notes-title">笔记管理</h1>
            <p class="notes-subtitle">班级: {{ class_obj.name }} | 管理所有白板笔记文件</p>
        </div>
        <div class="notes-actions">
            <button class="action-btn" onclick="refreshNotes()" title="刷新">
                <i class="material-icons">refresh</i>
                <span>刷新</span>
            </button>
            <a href="{{ url_for('classes.view_class', class_id=class_obj.id) }}" class="outline-btn">
                <i class="material-icons">arrow_back</i>
                <span>返回班级</span>
            </a>
        </div>
    </div>

    <!-- 统计信息 -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-value" id="total-notes">0</div>
            <div class="stat-label">总笔记数</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="total-size">0</div>
            <div class="stat-label">总大小</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="pdf-count">0</div>
            <div class="stat-label">PDF文件</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="image-count">0</div>
            <div class="stat-label">图片文件</div>
        </div>
    </div>

    <!-- 筛选和搜索 -->
    <div class="filters-section">
        <div class="filters-row">
            <div class="filter-group">
                <label class="filter-label">搜索笔记</label>
                <input type="text" id="search-input" class="search-input" placeholder="搜索文件名、标题、描述...">
            </div>
            <div class="filter-group">
                <label class="filter-label">白板筛选</label>
                <select id="whiteboard-filter" class="filter-select">
                    <option value="">所有白板</option>
                    {% for whiteboard in whiteboards %}
                    <option value="{{ whiteboard.id }}">{{ whiteboard.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="filter-group">
                <label class="filter-label">文件类型</label>
                <select id="filetype-filter" class="filter-select">
                    <option value="">所有类型</option>
                    <option value="pdf">PDF文档</option>
                    <option value="image">图片文件</option>
                    <option value="document">办公文档</option>
                    <option value="icstk">ICSTK文件</option>
                    <option value="other">其他文件</option>
                </select>
            </div>
            <div class="filter-group">
                <label class="filter-label">排序方式</label>
                <select id="sort-by" class="filter-select">
                    <option value="created_at">上传时间</option>
                    <option value="filename">文件名</option>
                    <option value="file_size">文件大小</option>
                    <option value="download_count">下载次数</option>
                </select>
            </div>
            <button class="primary-btn" onclick="applyFilters()">
                <i class="material-icons">search</i>
                <span>搜索</span>
            </button>
        </div>
    </div>

    <!-- 笔记表格 -->
    <div class="notes-table-container">
        <div style="position: relative;">
            <div id="loading-overlay" class="loading-overlay" style="display: none;">
                <div class="loading-spinner"></div>
            </div>
            
            <table class="notes-table">
                <thead>
                    <tr>
                        <th>文件信息</th>
                        <th>白板</th>
                        <th>上传者</th>
                        <th>文件大小</th>
                        <th>下载次数</th>
                        <th>上传时间</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="notes-table-body">
                    <!-- 笔记数据将通过JavaScript动态加载 -->
                </tbody>
            </table>
        </div>

        <!-- 空状态 -->
        <div id="empty-state" class="empty-state" style="display: none;">
            <div class="empty-content">
                <i class="material-icons empty-icon">note</i>
                <h3 class="empty-title">暂无笔记</h3>
                <p class="empty-description">该班级还没有上传任何笔记文件</p>
            </div>
        </div>

        <!-- 分页 -->
        <div class="pagination" id="pagination" style="display: none;">
            <div class="pagination-info" id="pagination-info"></div>
            <div class="pagination-controls">
                <button class="pagination-btn" id="prev-page" onclick="changePage(-1)">
                    <i class="material-icons">chevron_left</i>
                </button>
                <div id="page-numbers"></div>
                <button class="pagination-btn" id="next-page" onclick="changePage(1)">
                    <i class="material-icons">chevron_right</i>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 确认删除对话框 -->
<div id="delete-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center;">
    <div style="background: white; padding: 24px; border-radius: 12px; max-width: 400px; width: 90%;">
        <h3 style="margin-bottom: 16px; color: #2c3e50;">确认删除</h3>
        <p style="margin-bottom: 24px; color: #7f8c8d;">确定要删除这个笔记文件吗？此操作不可恢复。</p>
        <div style="display: flex; gap: 12px; justify-content: flex-end;">
            <button onclick="closeDeleteModal()" class="outline-btn">取消</button>
            <button onclick="confirmDelete()" class="primary-btn" style="background: #e74c3c;">确认删除</button>
        </div>
    </div>
</div>

<!-- 预览模态框 -->
<div id="preview-modal" class="preview-modal">
    <div class="preview-content">
        <button class="preview-close" onclick="closePreviewModal()">
            <i class="material-icons">close</i>
        </button>
        <div class="preview-body" id="preview-content">
            <!-- 预览内容将在这里动态加载 -->
        </div>
    </div>
</div>

<script>
// 全局变量
let currentPage = 1;
let totalPages = 1;
let currentFilters = {};
let noteToDelete = null;

// 页面加载完成后初始化
document.addEventListener('DOMContentLoaded', function() {
    loadNotes();
    loadStats();
    initPreviewFunctionality();
});

// 加载笔记列表
async function loadNotes() {
    showNotesLoading(true);
    
    try {
        const params = new URLSearchParams({
            page: currentPage,
            per_page: 20,
            ...currentFilters
        });
        
        const response = await fetch(`/web/notes/classes/{{ class_obj.id }}/notes?${params}`);
        const result = await response.json();
        
        if (result.success) {
            renderNotesTable(result.notes);
            updatePagination(result.pagination);
            updateStats(result.notes); // 更新统计信息
        } else {
            throw new Error(result.error || '加载笔记列表失败');
        }
    } catch (error) {
        console.error('Error:', error);
        showNotesMessage('加载笔记列表失败: ' + error.message, 'error');
    } finally {
        showNotesLoading(false);
    }
}

// 加载统计信息（从服务器获取）
async function loadStats() {
    try {
        // 这里可以调用专门的统计接口
        // 暂时使用笔记列表来计算
        const response = await fetch(`/web/notes/classes/{{ class_obj.id }}/notes?per_page=1000`);
        const result = await response.json();
        
        if (result.success) {
            updateStats(result.notes);
        }
    } catch (error) {
        console.error('加载统计信息失败:', error);
    }
}

// 更新统计信息
function updateStats(notes) {
    const totalNotes = notes.length;
    const totalSize = notes.reduce((sum, note) => sum + (note.file_size || 0), 0);
    const pdfCount = notes.filter(note => note.file_type === 'pdf').length;
    const imageCount = notes.filter(note => 
        ['png', 'jpg', 'jpeg', 'gif', 'bmp'].includes(note.file_type)
    ).length;
    
    document.getElementById('total-notes').textContent = totalNotes;
    document.getElementById('total-size').textContent = formatFileSize(totalSize);
    document.getElementById('pdf-count').textContent = pdfCount;
    document.getElementById('image-count').textContent = imageCount;
}

// 渲染笔记表格
function renderNotesTable(notes) {
    const tbody = document.getElementById('notes-table-body');
    const emptyState = document.getElementById('empty-state');
    const pagination = document.getElementById('pagination');
    
    if (!notes || notes.length === 0) {
        tbody.innerHTML = '';
        emptyState.style.display = 'block';
        pagination.style.display = 'none';
        return;
    }
    
    emptyState.style.display = 'none';
    pagination.style.display = 'flex';
    
    tbody.innerHTML = notes.map(note => `
        <tr>
            <td>
                <div class="file-info">
                    <div class="file-icon">
                        <i class="material-icons">${getFileIcon(note.file_type)}</i>
                    </div>
                    <div class="file-details">
                        <div class="file-name">${escapeHtml(note.title || note.original_filename)}</div>
                        <div class="file-meta">
                            ${note.file_type ? note.file_type.toUpperCase() + ' • ' : ''}
                            ${note.created_at ? new Date(note.created_at).toLocaleDateString('zh-CN') : '未知日期'}
                            ${note.tags ? '• ' + note.tags : ''}
                        </div>
                        ${note.description ? `<div class="file-description" style="margin-top: 4px; color: #7f8c8d; font-size: 12px;">${escapeHtml(note.description)}</div>` : ''}
                    </div>
                </div>
            </td>
            <td>${escapeHtml(note.whiteboard_name || '未知白板')}</td>
            <td>${escapeHtml(note.uploader_name || '未知用户')}</td>
            <td>${note.file_size_formatted || formatFileSize(note.file_size)}</td>
            <td>${note.download_count || 0}</td>
            <td>${note.created_at ? new Date(note.created_at).toLocaleDateString('zh-CN') : '未知'}</td>
            <td>
                <div class="actions-cell">
                    <button class="action-icon action-preview" onclick="previewNote(${note.id}, '${note.file_type || ''}')" title="预览">
                        <i class="material-icons">visibility</i>
                    </button>
                    <button class="action-icon action-download" onclick="downloadNote(${note.id})" title="下载">
                        <i class="material-icons">download</i>
                    </button>
                    <button class="action-icon action-delete" onclick="showDeleteModal(${note.id})" title="删除">
                        <i class="material-icons">delete</i>
                    </button>
                </div>
            </td>
        </tr>
    `).join('');
}

// 获取文件类型图标
function getFileIcon(fileType) {
    const iconMap = {
        'pdf': 'picture_as_pdf',
        'png': 'image',
        'jpg': 'image',
        'jpeg': 'image',
        'gif': 'image',
        'bmp': 'image',
        'txt': 'description',
        'md': 'description',
        'doc': 'description',
        'docx': 'description',
        'ppt': 'slideshow',
        'pptx': 'slideshow',
        'zip': 'folder_zip',
        'rar': 'folder_zip',
        'icstk': 'architecture' // ICSTK文件使用建筑图标
    };
    return iconMap[fileType] || 'insert_drive_file';
}

// 格式化文件大小
function formatFileSize(bytes) {
    if (!bytes) return '0 B';
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
    if (bytes < 1024 * 1024 * 1024) return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    return (bytes / (1024 * 1024 * 1024)).toFixed(1) + ' GB';
}

// 更新分页
function updatePagination(pagination) {
    const paginationEl = document.getElementById('pagination');
    const paginationInfo = document.getElementById('pagination-info');
    const pageNumbers = document.getElementById('page-numbers');
    const prevBtn = document.getElementById('prev-page');
    const nextBtn = document.getElementById('next-page');
    
    if (!pagination || pagination.pages <= 1) {
        paginationEl.style.display = 'none';
        return;
    }
    
    paginationEl.style.display = 'flex';
    currentPage = pagination.page || 1;
    totalPages = pagination.pages || 1;
    
    // 更新分页信息
    paginationInfo.textContent = `第 ${currentPage} 页，共 ${totalPages} 页，${pagination.total || 0} 条记录`;
    
    // 更新页码按钮
    pageNumbers.innerHTML = '';
    const startPage = Math.max(1, currentPage - 2);
    const endPage = Math.min(totalPages, currentPage + 2);
    
    for (let i = startPage; i <= endPage; i++) {
        const pageBtn = document.createElement('button');
        pageBtn.className = `pagination-btn ${i === currentPage ? 'active' : ''}`;
        pageBtn.textContent = i;
        pageBtn.onclick = () => goToPage(i);
        pageNumbers.appendChild(pageBtn);
    }
    
    // 更新按钮状态
    prevBtn.disabled = currentPage <= 1;
    nextBtn.disabled = currentPage >= totalPages;
}

// 切换页面
function changePage(delta) {
    const newPage = currentPage + delta;
    if (newPage >= 1 && newPage <= totalPages) {
        goToPage(newPage);
    }
}

// 跳转到指定页面
function goToPage(page) {
    currentPage = page;
    loadNotes();
}

// 应用筛选条件
function applyFilters() {
    currentFilters = {};
    
    const search = document.getElementById('search-input').value;
    const whiteboard = document.getElementById('whiteboard-filter').value;
    const filetype = document.getElementById('filetype-filter').value;
    const sortBy = document.getElementById('sort-by').value;
    
    if (search) currentFilters.search = search;
    if (whiteboard) currentFilters.whiteboard_id = whiteboard;
    if (filetype) {
        // 将前端分类映射到实际文件类型
        const typeMap = {
            'pdf': 'pdf',
            'image': 'png,jpg,jpeg,gif,bmp',
            'document': 'doc,docx,ppt,pptx,txt,md',
            'icstk': 'icstk',
            'other': 'zip,rar'
        };
        currentFilters.file_type = typeMap[filetype] || filetype;
    }
    if (sortBy) currentFilters.sort_by = sortBy;
    
    currentPage = 1;
    loadNotes();
}

// 下载笔记
function downloadNote(noteId) {
    window.open(`/web/notes/notes/${noteId}/download`, '_blank');
}

// 显示删除确认对话框
function showDeleteModal(noteId) {
    noteToDelete = noteId;
    document.getElementById('delete-modal').style.display = 'flex';
}

// 关闭删除确认对话框
function closeDeleteModal() {
    noteToDelete = null;
    document.getElementById('delete-modal').style.display = 'none';
}

// 确认删除
async function confirmDelete() {
    if (!noteToDelete) return;
    
    try {
        const response = await fetch(`/web/notes/notes/${noteToDelete}`, {
            method: 'DELETE'
        });
        
        const result = await response.json();
        
        if (result.success) {
            showNotesMessage('笔记删除成功', 'success');
            closeDeleteModal();
            loadNotes();
            loadStats();
        } else {
            throw new Error(result.error || '删除失败');
        }
    } catch (error) {
        console.error('Error:', error);
        showNotesMessage('删除失败: ' + error.message, 'error');
    }
}

// 刷新笔记列表
function refreshNotes() {
    loadNotes();
    loadStats();
    showNotesMessage('笔记列表已刷新', 'success');
}

// 显示/隐藏加载状态
function showNotesLoading(show) {
    document.getElementById('loading-overlay').style.display = show ? 'flex' : 'none';
}

// 显示消息提示
function showNotesMessage(message, type = 'success') {
    // 移除现有消息
    const existingMessages = document.querySelectorAll('.message');
    existingMessages.forEach(msg => msg.remove());
    
    const messageEl = document.createElement('div');
    messageEl.className = `message ${type}`;
    messageEl.innerHTML = `
        <div class="message-content">
            <i class="material-icons message-icon">${type === 'error' ? 'error' : 'check_circle'}</i>
            <span class="message-text">${message}</span>
        </div>
    `;
    document.body.appendChild(messageEl);
    
    setTimeout(() => {
        if (document.body.contains(messageEl)) {
            messageEl.remove();
        }
    }, 3000);
}

// HTML转义
function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// 监听搜索输入框的Enter键
document.getElementById('search-input').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        applyFilters();
    }
});

// ========== 预览功能 ==========

// 初始化预览功能
function initPreviewFunctionality() {
    // 添加键盘支持（ESC键关闭预览）
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closePreviewModal();
        }
    });

    // 点击模态框背景关闭预览（使用事件委托）
    document.addEventListener('click', function(e) {
        const previewModal = document.getElementById('preview-modal');
        if (previewModal && e.target === previewModal) {
            closePreviewModal();
        }
    });
}

// 判断是否为图片文件
function isImageFile(fileType) {
    return ['png', 'jpg', 'jpeg', 'gif', 'bmp'].includes(fileType);
}

// 判断是否为文本文件
function isTextFile(fileType) {
    return ['txt', 'md'].includes(fileType);
}

// 预览笔记
function previewNote(noteId, fileType) {
    const previewModal = document.getElementById('preview-modal');
    const previewContent = document.getElementById('preview-content');
    
    // 检查元素是否存在
    if (!previewModal || !previewContent) {
        console.error('Preview modal elements not found');
        showNotesMessage('预览功能初始化失败，请刷新页面重试', 'error');
        return;
    }
    
    // 显示加载状态
    previewContent.innerHTML = `
        <div style="padding: 40px;">
            <div class="loading-spinner" style="margin: 0 auto;"></div>
            <p style="margin-top: 16px; color: #7f8c8d;">正在加载预览...</p>
        </div>
    `;
    
    previewModal.style.display = 'flex';
    
    // 使用新的预览路由，不增加下载计数
    const previewUrl = `/web/notes/notes/${noteId}/preview`;
    const downloadUrl = `/web/notes/notes/${noteId}/download`;
    
    if (isImageFile(fileType)) {
        previewImage(previewUrl, downloadUrl, fileType, previewContent);
    } else if (fileType === 'pdf') {
        previewPDF(previewUrl, downloadUrl, previewContent);
    } else if (isTextFile(fileType)) {
        previewText(previewUrl, downloadUrl, previewContent);
    } else if (fileType === 'icstk') {
        previewICSTK(previewUrl, downloadUrl, previewContent);
    } else {
        previewUnsupported(fileType, downloadUrl, previewContent);
    }
}

// 预览图片
function previewImage(previewUrl, downloadUrl, fileType, container) {
    if (!container) return;
    
    container.innerHTML = `
        <div style="text-align: center;">
            <img src="${previewUrl}" 
                 alt="预览图片"
                 style="max-width: 100%; max-height: 70vh; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); cursor: pointer;"
                 onclick="openInNewTab('${previewUrl}')"
                 onload="this.style.opacity='1'" 
                 onerror="previewError(this, '${downloadUrl}')"
                 style="opacity: 0; transition: opacity 0.3s ease;">
            <div style="margin-top: 16px; display: flex; gap: 12px; justify-content: center;">
                <button onclick="openInNewTab('${previewUrl}')" class="outline-btn">
                    <i class="material-icons">open_in_new</i>新标签页查看
                </button>
                <button onclick="downloadNoteFromPreview('${downloadUrl}')" class="primary-btn">
                    <i class="material-icons">download</i>下载图片
                </button>
            </div>
            <p style="margin-top: 12px; color: #7f8c8d; font-size: 14px;">
                点击图片或按钮在新标签页查看 • 使用鼠标滚轮缩放
            </p>
        </div>
    `;
}

// 预览PDF
function previewPDF(previewUrl, downloadUrl, container) {
    if (!container) return;
    
    container.innerHTML = `
        <div style="text-align: center;">
            <embed src="${previewUrl}#toolbar=1&navpanes=1" 
                   type="application/pdf" 
                   width="100%" 
                   height="500px" 
                   style="border-radius: 8px; border: 1px solid #ecf0f1;">
            <div style="margin-top: 16px; display: flex; gap: 12px; justify-content: center;">
                <button onclick="openInNewTab('${previewUrl}')" class="outline-btn">
                    <i class="material-icons">open_in_new</i>新标签页查看
                </button>
                <button onclick="downloadNoteFromPreview('${downloadUrl}')" class="primary-btn">
                    <i class="material-icons">download</i>下载PDF
                </button>
            </div>
        </div>
    `;
}

// 预览文本文件
function previewText(previewUrl, downloadUrl, container) {
    if (!container) return;
    
    fetch(previewUrl)
        .then(response => {
            if (!response.ok) throw new Error('加载失败');
            return response.text();
        })
        .then(text => {
            if (!container) return;
            
            container.innerHTML = `
                <div style="text-align: left; max-width: 800px; margin: 0 auto;">
                    <div style="display: flex; gap: 12px; justify-content: center; margin-bottom: 16px;">
                        <button onclick="openInNewTab('${previewUrl}')" class="outline-btn">
                            <i class="material-icons">open_in_new</i>新标签页查看
                        </button>
                        <button onclick="downloadNoteFromPreview('${downloadUrl}')" class="primary-btn">
                            <i class="material-icons">download</i>下载文本
                        </button>
                    </div>
                    <pre style="background: #f8f9fa; padding: 20px; border-radius: 8px; max-height: 400px; overflow: auto; white-space: pre-wrap; font-family: 'Courier New', monospace; font-size: 14px; line-height: 1.4;">${escapeHtml(text)}</pre>
                </div>
            `;
        })
        .catch(error => {
            if (!container) return;
            
            container.innerHTML = `
                <div style="padding: 40px; text-align: center;">
                    <i class="material-icons" style="font-size: 48px; color: #e74c3c;">error</i>
                    <h3 style="margin: 16px 0; color: #2c3e50;">加载失败</h3>
                    <p style="color: #7f8c8d; margin-bottom: 24px;">无法加载文本内容：${error.message}</p>
                    <div style="display: flex; gap: 12px; justify-content: center;">
                        <button onclick="openInNewTab('${previewUrl}')" class="outline-btn">
                            <i class="material-icons">open_in_new</i>尝试新标签页查看
                        </button>
                        <button onclick="downloadNoteFromPreview('${downloadUrl}')" class="primary-btn">
                            <i class="material-icons">download</i>直接下载文件
                        </button>
                    </div>
                </div>
            `;
        });
}

// 预览ICSTK文件
function previewICSTK(previewUrl, downloadUrl, container) {
    if (!container) return;
    
    container.innerHTML = `
        <div style="padding: 40px; text-align: center;">
            <i class="material-icons" style="font-size: 64px; color: #9b59b6;">architecture</i>
            <h3 style="margin: 16px 0; color: #2c3e50;">ICSTK 文件</h3>
            <p style="margin-bottom: 24px; color: #7f8c8d;">
                ICSTK 文件需要专用软件打开，无法在浏览器中预览。
            </p>
            <div style="display: flex; gap: 12px; justify-content: center;">
                <button onclick="openInNewTab('${previewUrl}')" class="outline-btn">
                    <i class="material-icons">open_in_new</i>尝试新标签页查看
                </button>
                <button onclick="downloadNoteFromPreview('${downloadUrl}')" class="primary-btn">
                    <i class="material-icons">download</i>下载文件
                </button>
            </div>
        </div>
    `;
}

// 不支持预览的文件类型
function previewUnsupported(fileType, downloadUrl, container) {
    if (!container) return;
    
    container.innerHTML = `
        <div style="padding: 40px; text-align: center;">
            <i class="material-icons" style="font-size: 48px; color: #bdc3c7;">insert_drive_file</i>
            <h3 style="margin: 16px 0; color: #2c3e50;">不支持预览</h3>
            <p style="margin-bottom: 24px; color: #7f8c8d;">该文件类型 (.${fileType}) 不支持在线预览，请下载后查看。</p>
            <div style="display: flex; gap: 12px; justify-content: center;">
                <button onclick="closePreviewModal()" class="outline-btn">取消</button>
                <button onclick="downloadNoteFromPreview('${downloadUrl}')" class="primary-btn">
                    <i class="material-icons">download</i>下载文件
                </button>
            </div>
        </div>
    `;
}

// 在新标签页打开
function openInNewTab(url) {
    window.open(url, '_blank');
}

// 从预览模态框下载文件
function downloadNoteFromPreview(downloadUrl) {
    if (downloadUrl) {
        window.open(downloadUrl, '_blank');
    }
    closePreviewModal();
}

// 关闭预览模态框
function closePreviewModal() {
    const previewModal = document.getElementById('preview-modal');
    const previewContent = document.getElementById('preview-content');
    
    if (previewModal) {
        previewModal.style.display = 'none';
    }
    if (previewContent) {
        previewContent.innerHTML = '';
    }
}

// 图片加载错误处理
function previewError(imgElement, downloadUrl) {
    const container = imgElement.parentElement;
    if (!container) return;
    
    container.innerHTML = `
        <div style="padding: 40px; text-align: center;">
            <i class="material-icons" style="font-size: 48px; color: #e74c3c;">broken_image</i>
            <h3 style="margin: 16px 0; color: #2c3e50;">图片加载失败</h3>
            <p style="color: #7f8c8d; margin-bottom: 24px;">无法加载图片预览，请尝试在新标签页查看或下载文件。</p>
            <div style="display: flex; gap: 12px; justify-content: center;">
                <button onclick="closePreviewModal()" class="outline-btn">关闭</button>
                <button onclick="downloadNoteFromPreview('${downloadUrl}')" class="primary-btn">
                    <i class="material-icons">download</i>下载文件
                </button>
            </div>
        </div>
    `;
}
</script>
{% endblock %}